# Notion 机器数据库管理功能

## 📋 概述

新增的 Notion 机器数据库管理功能允许用户通过QQ群聊来查询和管理系统中的机器信息。基于您提供的 Notion 数据库，实现了完整的机器信息查询和管理功能。

## 🔧 功能特性

### 1. **机器查询功能**
- **根据产物查询**: 查找可以生产特定物品的机器
- **根据地域查询**: 查找特定地域的所有机器
- **机器详细信息**: 获取机器的完整信息
- **地域列表**: 查看所有可用地域
- **产物列表**: 查看所有可生产的物品

### 2. **信息展示**
- 机器名称和基本信息
- 所在地域和具体坐标
- 可生产的所有产物
- 可维护者信息
- 最后修改时间

## 📱 QQ群聊命令

### 机器查询命令

| 命令 | 格式 | 说明 | 示例 |
|------|------|------|------|
| **产物查询** | `#machine_search <产物名称>` | 查找生产指定物品的机器 | `#machine_search 铁锭` |
| **地域查询** | `#machine_region <地域名称>` | 查找指定地域的所有机器 | `#machine_region 江都市` |
| **地域列表** | `#machine_regions` | 显示所有可用地域 | `#machine_regions` |
| **产物列表** | `#machine_products` | 显示所有可生产物品 | `#machine_products` |
| **机器详情** | `#machine_detail <机器名称>` | 获取机器详细信息 | `#machine_detail 通天塔刷铁机` |

### 回复格式示例

#### 产物查询回复
```
🔍 找到 2 台生产 '铁锭' 的机器:

1. 通天塔刷铁机
   📍 地域: 江都市
   📦 产物: 铁锭, 铁块
   👤 维护者: 玩家A, 玩家B
   🌍 位置: 主世界 -1800 56 2866

2. 工业刷铁机
   📍 地域: 樱岭
   📦 产物: 铁锭
   🌍 位置: 主世界 -3191 68 8620
```

#### 地域查询回复
```
🏭 江都市 地域的机器列表:

1. 通天塔刷铁机
   📦 产物: 铁锭, 铁块
   🌍 位置: 主世界 -1800 56 2866

2. 红石工厂
   📦 产物: 红石火把, 红石中继器
   🌍 位置: 主世界 -2052 73 3183
```

#### 机器详情回复
```
📋 机器详细信息: 通天塔刷铁机

🏭 地域: 江都市
📦 产物: 铁锭, 铁块
👤 可维护者: 玩家A, 玩家B
🌍 维度: 主世界
📍 坐标: -1800 56 2866
📅 创建时间: 2024-08-23
🔄 最后修改: 2024-08-23
```

## 🛠️ 技术实现

### 核心组件

1. **MachineManager** (`services/machine_manager.py`)
   - 机器数据库查询和管理
   - Notion API 集成
   - 数据格式转换

2. **Notion Handler** (`handlers/notion_handler.py`)
   - QQ命令解析和处理
   - 结果格式化和回复

### 数据结构

机器信息包含以下字段：
```python
{
    'id': 'notion页面ID',
    'name': '机器名称',
    'region': '地域',
    'products': ['产物1', '产物2', ...],
    'maintainers': ['维护者1', '维护者2', ...],
    'dimension': '维度',
    'coordinates': '坐标',
    'created_time': '创建时间',
    'last_edited_time': '最后修改时间'
}
```

## ⚙️ 配置说明

### Notion API 配置

项目已配置了 Notion 集成密钥：
- **集成密钥**: `YOUR_NOTION_TOKEN_HERE`（请在config.py中设置）
- **数据库ID**: `YOUR_DATABASE_ID_HERE`（请在config.py中设置）
- **版本**: `2022-06-28`

### 数据库权限

确保您的 Notion 集成有以下权限：
- ✅ 读取数据库内容
- ✅ 读取页面内容
- ✅ 搜索内容（如果需要）

## 🚀 使用方法

### 1. 启动服务
```bash
python app.py
```

### 2. 在QQ群中使用

#### 查询铁锭生产机器
```
用户: #machine_search 铁锭
机器人: 🔍 找到 2 台生产 '铁锭' 的机器:

1. 通天塔刷铁机
   📍 地域: 江都市
   📦 产物: 铁锭, 铁块
   👤 维护者: 玩家A, 玩家B
   🌍 位置: 主世界 -1800 56 2866

2. 工业刷铁机
   📍 地域: 樱岭
   📦 产物: 铁锭
   🌍 位置: 主世界 -3191 68 8620
```

#### 查询江都市所有机器
```
用户: #machine_region 江都市
机器人: 🏭 江都市 地域的机器列表:

1. 通天塔刷铁机
   📦 产物: 铁锭, 铁块
   🌍 位置: 主世界 -1800 56 2866

2. 红石工厂
   📦 产物: 红石火把, 红石中继器, ...
   🌍 位置: 主世界 -2052 73 3183
```

#### 查看所有地域
```
用户: #machine_regions
机器人: 🌍 所有可用地域 (8 个):
• 江都市
• 樱岭
• 幻想乡
• Lee塘
• 三联市
• 西西伯利亚
• 思源市
• 校徽
```

#### 获取机器详细信息
```
用户: #machine_detail 通天塔刷铁机
机器人: 📋 机器详细信息: 通天塔刷铁机

🏭 地域: 江都市
📦 产物: 铁锭, 铁块
👤 可维护者: 玩家A, 玩家B
🌍 维度: 主世界
📍 坐标: -1800 56 2866
📅 创建时间: 2024-08-23
🔄 最后修改: 2024-08-23
```

## 🔍 高级查询功能

### 多产物查询
如果一个机器生产多个产物，可以通过任意产物名称找到该机器：
```
#machine_search 铁锭    # 找到通天塔刷铁机
#machine_search 铁块    # 同样找到通天塔刷铁机
```

### 模糊匹配
系统支持部分匹配，可以使用关键词查询：
```
#machine_search 刷石机    # 找到所有刷石机
#machine_search 树场      # 找到所有树场
```

## 📊 性能优化

### 响应优化
- 消息长度超过1000字符时自动分段发送
- 异步处理查询请求，避免阻塞
- 缓存常用查询结果

### 错误处理
- 网络异常时的重试机制
- 无效查询的友好提示
- 详细的错误日志记录

## 🔧 扩展开发

### 添加新查询功能
在 `services/machine_manager.py` 中添加新方法：
```python
def search_by_maintainer(self, maintainer: str) -> List[Dict[str, Any]]:
    # 根据维护者查询机器
    pass
```

### 添加新命令
在 `handlers/notion_handler.py` 中添加处理函数：
```python
def handle_machine_maintainer_command(event_data):
    # 处理维护者查询命令
    pass
```

然后在 `app.py` 的 `COMMAND_ROUTER` 中注册：
```python
'#machine_maintainer': notion_handler.handle_machine_maintainer_command,
```

## 📝 注意事项

### 1. 权限管理
- 确保 Notion 集成有足够的数据库访问权限
- 检查数据库分享设置是否正确

### 2. 数据更新
- Notion 数据库更新后，查询结果会实时反映最新状态
- 支持实时查询，无需重启服务

### 3. 性能考虑
- 大量查询时注意 API 限制
- 建议在非高峰时段进行大量数据操作

## 🎯 未来扩展

### 计划功能
1. **机器编辑功能**: 通过QQ修改机器信息
2. **批量操作**: 批量查询和更新
3. **统计功能**: 机器使用统计和分析
4. **地图集成**: 与游戏地图坐标集成

### API扩展
1. **Web界面**: 提供网页版管理界面
2. **数据导出**: 支持数据导出为Excel
3. **自动化报告**: 定期生成机器状态报告

---

**版本**: v1.0.0
**更新日期**: 2024年8月23日
**开发者**: AI Assistant