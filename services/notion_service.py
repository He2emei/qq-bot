# services/notion_service.py
import requests
from datetime import datetime, timedelta, date
from typing import Dict, Any, Optional
import json
import os
import time
import config


class NotionService:
    """Notion API 服务类"""

    def __init__(self, token_type="default"):
        self.base_url = "https://api.notion.com/v1/"
        self.token_type = token_type
        self._init_headers()
        self.session = requests.Session()
        if hasattr(config, 'NOTION_PROXY') and config.NOTION_PROXY:
            self.session.proxies = {"http": config.NOTION_PROXY, "https": config.NOTION_PROXY}
        # 设置默认超时时间
        self.timeout = 30
        self.max_retries = 3

    def _init_headers(self):
        """初始化请求头，根据token类型选择不同的token"""
        if self.token_type == "diary":
            token = config.NOTION_TOKEN_DIARY
        else:
            token = config.NOTION_TOKEN

        self.headers = {
            "Authorization": f"Bearer {token}",
            "notion-version": config.NOTION_VERSION
        }
        print(self.headers)

    def _make_request_with_retry(self, method: str, url: str, **kwargs) -> requests.Response:
        """带重试机制的请求方法"""
        kwargs.setdefault('timeout', self.timeout)

        for attempt in range(self.max_retries):
            try:
                response = self.session.request(method, url, headers=self.headers, **kwargs)
                response.raise_for_status()
                return response
            except requests.exceptions.ConnectionError as e:
                if attempt == self.max_retries - 1:
                    raise Exception(f"Connection failed after {self.max_retries} attempts: {e}")
                print(f"Connection attempt {attempt + 1} failed, retrying in 2 seconds...")
                time.sleep(2)
            except requests.exceptions.Timeout as e:
                if attempt == self.max_retries - 1:
                    raise Exception(f"Request timeout after {self.max_retries} attempts: {e}")
                print(f"Request timeout attempt {attempt + 1}, retrying in 2 seconds...")
                time.sleep(2)
            except requests.exceptions.HTTPError as e:
                if e.response.status_code >= 500:
                    if attempt == self.max_retries - 1:
                        raise Exception(f"Server error after {self.max_retries} attempts: {e}")
                    print(f"Server error (status {e.response.status_code}) attempt {attempt + 1}, retrying in 3 seconds...")
                    time.sleep(3)
                else:
                    # 对于客户端错误（如401，404），直接抛出
                    raise Exception(f"HTTP error: {e}")
            except Exception as e:
                if attempt == self.max_retries - 1:
                    raise Exception(f"Request failed after {self.max_retries} attempts: {e}")
                print(f"Request attempt {attempt + 1} failed: {e}, retrying in 2 seconds...")
                time.sleep(2)

        raise Exception(f"Request failed after {self.max_retries} attempts")

    def _get_database_id(self, database_name: str) -> str:
        """获取数据库ID"""
        if database_name == "Daily Dairy 2.0":
            return config.NOTION_DATABASES['daily']
        elif database_name == "Weekly Dairy 2.0":
            return config.NOTION_DATABASES['weekly']
        elif database_name == "Terms Dairy 2.0":
            return config.NOTION_DATABASES['terms']
        else:
            raise ValueError(f"Unknown database: {database_name}")

    def query_database(self, database_name: str, filter_json: Optional[Dict] = None) -> Dict[str, Any]:
        """查询数据库"""
        database_id = self._get_database_id(database_name)
        url = f"{self.base_url}databases/{database_id}/query/"

        payload = {}
        if filter_json:
            payload = {"filter": filter_json}

        response = self._make_request_with_retry("POST", url, json=payload, verify=False)
        return response.json()

    def add_page(self, database_name: str, page_data: Dict[str, Any]) -> Dict[str, Any]:
        """添加页面"""
        database_id = self._get_database_id(database_name)
        url = f"{self.base_url}pages/"

        # 确保 parent 设置正确
        page_data["parent"] = {
            "type": "database_id",
            "database_id": database_id
        }

        response = self._make_request_with_retry("POST", url, json=page_data)
        return response.json()

    def update_page(self, page_id: str, update_data: Dict[str, Any]) -> Dict[str, Any]:
        """更新页面"""
        url = f"{self.base_url}pages/{page_id}"

        response = self._make_request_with_retry("PATCH", url, json=update_data)
        return response.json()

    def get_page_children(self, page_id: str) -> Dict[str, Any]:
        """获取页面子项"""
        url = f"{self.base_url}blocks/{page_id}/children"

        response = self._make_request_with_retry("GET", url)
        return response.json()


class NotionWeeklyManager:
    """每周日记管理器"""

    def __init__(self):
        self.notion_service = NotionService(token_type="diary")

    def get_week_start_date(self, dt: datetime) -> datetime:
        """获取日期所在周的周一日期"""
        # 获取当前日期是星期几（0 = 周一，6 = 周日）
        weekday = dt.weekday()
        # 计算本周周一的日期
        week_start = dt - timedelta(days=weekday)
        return week_start

    def get_date_no_dash(self, dt: datetime) -> str:
        """获取没有'-'的日期字符串"""
        return dt.strftime("%Y%m%d")

    def date_dt2nt(self, dt: datetime) -> str:
        """datetime转Notion日期字符串"""
        return dt.strftime("%Y-%m-%d")

    def get_week_filter(self, week_start: datetime) -> Dict[str, Any]:
        """获取周过滤器"""
        return {
            "property": "Date",
            "date": {
                "equals": self.date_dt2nt(week_start)
            }
        }

    def get_current_week_page(self) -> Optional[Dict[str, Any]]:
        """获取本周的日记页面"""
        today = datetime.now()
        week_start = self.get_week_start_date(today)
        filter_json = self.get_week_filter(week_start)

        try:
            result = self.notion_service.query_database("Weekly Dairy 2.0", filter_json)
            if result["results"]:
                return result["results"][0]
        except Exception as e:
            print(f"获取本周日记页面时出错: {e}")

        return None

    def add_current_week_page(self) -> Dict[str, Any]:
        """添加本周的日记页面"""
        today = datetime.now()
        week_start = self.get_week_start_date(today)
        week_end = week_start + timedelta(days=6)

        # 加载模板
        import json
        import os
        template_path = config.NOTION_DATA_PATHS['weekly_template']
        if os.path.exists(template_path):
            with open(template_path, 'r', encoding='utf-8') as f:
                page_data = json.load(f)
        else:
            # 默认模板（基于Notion-Tools的格式）
            page_data = {
                "properties": {
                    "Date": {
                        "type": "date",
                        "date": {
                            "start": self.date_dt2nt(week_start),
                            "end": self.date_dt2nt(week_end)
                        }
                    },
                    "Name": {
                        "type": "title",
                        "title": [
                            {
                                "type": "text",
                                "text": {
                                    "content": f"Week of {self.date_dt2nt(week_start)}"
                                }
                            }
                        ]
                    }
                }
            }

        # 更新模板中的日期（参考Notion-Tools的做法）
        page_data["properties"]["Date"]["date"]["start"] = self.date_dt2nt(week_start)
        page_data["properties"]["Date"]["date"]["end"] = self.date_dt2nt(week_end)

        # 更新Name字段
        page_data["properties"]["Name"]["title"][0]["text"]["content"] = f"Week of {self.date_dt2nt(week_start)}"

        try:
            result = self.notion_service.add_page("Weekly Dairy 2.0", page_data)
            print(f"Added current week page: {self.date_dt2nt(week_start)} to {self.date_dt2nt(week_end)}")
            return result
        except Exception as e:
            print(f"Error adding current week page: {e}")
            raise


class NotionDailyManager:
    """每日日记管理器"""

    def __init__(self):
        self.notion_service = NotionService(token_type="diary")

    def get_today_date(self) -> date:
        """获取今日日期"""
        return datetime.now().date()

    def get_date_no_dash(self, dt: datetime) -> str:
        """获取没有'-'的日期字符串"""
        return dt.strftime("%Y%m%d")

    def date_dt2nt(self, dt: datetime) -> str:
        """datetime转Notion日期字符串"""
        return dt.strftime("%Y-%m-%d")

    def get_day_filter(self, target_date: datetime) -> Dict[str, Any]:
        """获取日期过滤器"""
        return {
            "property": "Date",
            "date": {
                "equals": self.date_dt2nt(target_date)
            }
        }

    def get_today_page(self) -> Optional[Dict[str, Any]]:
        """获取今天的日记页面"""
        today = datetime.now()
        filter_json = self.get_day_filter(today)

        try:
            result = self.notion_service.query_database("Daily Dairy 2.0", filter_json)
            if result["results"]:
                return result["results"][0]
        except requests.exceptions.ConnectionError as e:
            print(f"网络连接错误，无法获取今日日记页面: {e}")
        except requests.exceptions.Timeout as e:
            print(f"请求超时，无法获取今日日记页面: {e}")
        except requests.exceptions.HTTPError as e:
            print(f"HTTP错误，无法获取今日日记页面: {e}")
        except Exception as e:
            print(f"获取今日日记页面时出现未知错误: {e}")

        return None

    def add_today_page(self, with_cover: bool = False) -> Dict[str, Any]:
        """添加今天的日记页面"""
        today = datetime.now()

        # 加载模板
        import json
        import os
        template_path = config.NOTION_DATA_PATHS['daily_template']
        if os.path.exists(template_path):
            with open(template_path, 'r', encoding='utf-8') as f:
                page_data = json.load(f)
        else:
            # 默认模板（基于Notion-Tools的格式）
            page_data = {
                "properties": {
                    "Date": {
                        "type": "date",
                        "date": {
                            "start": self.date_dt2nt(today)
                        }
                    },
                    "Name": {
                        "type": "title",
                        "title": [
                            {
                                "type": "mention",
                                "mention": {
                                    "type": "date",
                                    "date": {
                                        "start": self.date_dt2nt(today)
                                    }
                                }
                            },
                            {
                                "type": "text",
                                "text": {
                                    "content": f" {self.get_date_no_dash(today)}"
                                }
                            }
                        ]
                    }
                }
            }

        # 更新模板中的日期（参考Notion-Tools的做法）
        page_data["properties"]["Date"]["date"]["start"] = self.date_dt2nt(today)
        page_data["properties"]["Name"]["title"][0]["mention"]["date"]["start"] = self.date_dt2nt(today)
        page_data["properties"]["Name"]["title"][1]["text"]["content"] = f" {self.get_date_no_dash(today)}"

        # 如果需要封面，添加Bing壁纸（参考Notion-Tools的做法）
        if with_cover:
            try:
                from utils.notion_utils import get_bing_image_url
                page_data["cover"]["external"]["url"] = get_bing_image_url()
            except Exception as e:
                print(f"Error getting Bing image: {e}")
                # 使用默认图片
                page_data["cover"]["external"]["url"] = "https://picsum.photos/800/600?random=1"

        # 调试输出
        import json
        print(f"DEBUG: Daily page data: {json.dumps(page_data, indent=2, ensure_ascii=False)}")

        try:
            result = self.notion_service.add_page("Daily Dairy 2.0", page_data)
            print(f"Added today page: {self.date_dt2nt(today)}")
            return result
        except Exception as e:
            print(f"Error adding today page: {e}")
            raise

    def update_daily_cover(self) -> bool:
        """更新今日日记封面"""
        try:
            from utils.notion_utils import get_bing_image_url

            today_page = self.get_today_page()
            if not today_page:
                print("No today page found to update")
                return False

            update_data = {
                "cover": {
                    "type": "external",
                    "external": {
                        "url": get_bing_image_url()
                    }
                }
            }

            result = self.notion_service.update_page(today_page["id"], update_data)
            print(f"Updated cover for page: {today_page['id']}")
            return True

        except Exception as e:
            print(f"Error updating daily cover: {e}")
            return False


class NotionWeeklyManager:
    """每周日记管理器"""

    def __init__(self):
        self.notion_service = NotionService(token_type="diary")

    def get_week_start_date(self, dt: datetime) -> datetime:
        """获取日期所在周的周一日期"""
        # 获取当前日期是星期几（0 = 周一，6 = 周日）
        weekday = dt.weekday()
        # 计算本周周一的日期
        week_start = dt - timedelta(days=weekday)
        return week_start

    def get_date_no_dash(self, dt: datetime) -> str:
        """获取没有'-'的日期字符串"""
        return dt.strftime("%Y%m%d")

    def date_dt2nt(self, dt: datetime) -> str:
        """datetime转Notion日期字符串"""
        return dt.strftime("%Y-%m-%d")

    def get_week_filter(self, week_start: datetime) -> Dict[str, Any]:
        """获取周过滤器"""
        return {
            "property": "Date",
            "date": {
                "equals": self.date_dt2nt(week_start)
            }
        }

    def get_current_week_page(self) -> Optional[Dict[str, Any]]:
        """获取本周的日记页面"""
        today = datetime.now()
        week_start = self.get_week_start_date(today)
        filter_json = self.get_week_filter(week_start)

        try:
            result = self.notion_service.query_database("Weekly Dairy 2.0", filter_json)
            if result["results"]:
                return result["results"][0]
        except Exception as e:
            print(f"获取本周日记页面时出错: {e}")

        return None

    def add_current_week_page(self) -> Dict[str, Any]:
        """添加本周的日记页面"""
        today = datetime.now()
        week_start = self.get_week_start_date(today)
        week_end = week_start + timedelta(days=6)

        # 构建页面数据
        page_data = {
            "properties": {
                "Date": {
                    "type": "date",
                    "date": {
                        "start": self.date_dt2nt(week_start),
                        "end": self.date_dt2nt(week_end)
                    }
                },
                "Name": {
                    "type": "title",
                    "title": [
                        {
                            "type": "text",
                            "text": {
                                "content": f"Week of {self.date_dt2nt(week_start)}"
                            }
                        }
                    ]
                }
            }
        }

        try:
            result = self.notion_service.add_page("Weekly Dairy 2.0", page_data)
            print(f"Added current week page: {self.date_dt2nt(week_start)} to {self.date_dt2nt(week_end)}")
            return result
        except Exception as e:
            print(f"Error adding current week page: {e}")
            raise


# 全局服务实例
notion_service = NotionService()
daily_manager = NotionDailyManager()
weekly_manager = NotionWeeklyManager()
